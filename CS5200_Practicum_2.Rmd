---
title: "Practicum_Two"
output:
  pdf_document: default
  html_notebook: default
---
# Create database schema
## Connect to database
```{r}
library(RSQLite)

dbFile = "./Practicum2.sqlite"

dbcon <- dbConnect(RSQLite::SQLite(), dbFile)
```

## Create table Author
```{sql connection=dbcon}
DROP TABLE IF EXISTS Author;
```

```{sql connection=dbcon}
CREATE TABLE Author (
  authorId INTEGER PRIMARY KEY,
  lastName TEXT,
  foreName TEXT,
  initials TEXT
);
```

## Create table Journal
```{sql connection=dbcon}
DROP TABLE IF EXISTS Journal;
```

```{sql connection=dbcon}
CREATE TABLE Journal (
  ISSN TEXT PRIMARY KEY,
  title TEXT NOT NULL,
  isoabbreviation TEXT NOT NULL
);
```

## Create table JournalIssue
```{sql connection=dbcon}
DROP TABLE IF EXISTS JournalIssue;
```

```{sql connection=dbcon}
CREATE TABLE JournalIssue (
  jId INTEGER PRIMARY KEY,
  ISSN INTEGER REFERENCES Journal(ISSN) ON DELETE CASCADE,
  volume INTEGER NOT NULL,
  issue INTEGER NOT NULL,
  pubYear TEXT NOT NULL,
  pubMonth TEXT NOT NULL
);
```

## Create table AuthorShip
```{sql connection=dbcon}
DROP TABLE IF EXISTS AuthorShip;
```

```{sql connection=dbcon}
CREATE TABLE AuthorShip (
  articleId INTEGER,
  authorId INTEGER,
  PRIMARY KEY (articleId, authorId)
)
```

## Create table Article
```{sql connection=dbcon}
DROP TABLE IF EXISTS Article;
```

```{sql connection=dbcon}
CREATE TABLE Article (
  articleId INTEGER PRIMARY KEY,
  jId INTEGER REFERENCES JournalIssue(jId) ON DELETE CASCADE,
  pubMode TEXT NOT NULL,
  title TEXT NOT NULL,
  abstract TEXT NOT NULL
)
```

## Create table History
```{sql connection=dbcon}
DROP TABLE IF EXISTS History;
```

```{sql connection=dbcon}
CREATE TABLE History (
  hId INTEGER PRIMARY KEY,
  articleId INTEGER REFERENCES Article(articleId) ON DELETE CASCADE,
  pubStatus TEXT NOT NULL,
  year INTEGER NOT NULL,
  month INTEGER NOT NULL,
  day INTEGER NOT NULL
)
```

# Loading Libraries

```{r warning=FALSE}
library(XML)
library(xslt)
```

# Load XML data to database
## Read XML file
```{r}
xmlPath <- "./pubmed_sample.xml"
xmlDoc = read_xml(xmlPath)
```

## Load Journal table
```{r}
# Extract Journal Data
xslPath = "./journal.xsl"
xslDoc = read_xml(xslPath,package="xslt")
journal_raw = xml_xslt(xmlDoc,xslDoc)
journals = unique(xmlToDataFrame(XML::xmlParse(journal_raw)))
dbWriteTable(dbcon,name = "Journal", value = journals, append = TRUE)
```

## Load Author table
```{r}
# Extract Author Data
xslPath = "./author.xsl"
xslDoc = read_xml(xslPath,package="xslt")
author_raw = xml_xslt(xmlDoc,xslDoc)
authors = unique(xmlToDataFrame(XML::xmlParse(author_raw)))
authors = cbind(authorId=rownames(authors),authors)
dbWriteTable(dbcon,name = "Author", value = authors, append = TRUE)
```

```{sql connection=dbcon}
SELECT * FROM Author;
```
## Load JournalIssue table
```{r}
# Extract JournalIssue Data
xslPath = "./journalIssue.xsl"
xslDoc = read_xml(xslPath,package="xslt")
journalIssue_raw = xml_xslt(xmlDoc,xslDoc)
journalIssues = unique(xmlToDataFrame(XML::xmlParse(journalIssue_raw)))
journalIssues = cbind(jId=rownames(journalIssues),journalIssues)
medDate <- journalIssues$medlineDate
for (i in 1 : nrow(journalIssues)) {
  if (medDate[i] != '') {
  pubDate <- strsplit(medDate[i],split = ' ')
  journalIssues$pubYear[i] = pubDate[[1]][1]
  journalIssues$pubMonth[i] = pubDate[[1]][2]
  }
}
journalIssues <- subset(journalIssues, select = -c(7))
dbWriteTable(dbcon,name = "JournalIssue", value = journalIssues, append = TRUE)
```

```{sql connection=dbcon}
SELECT * FROM JournalIssue;
```

## Load Article table
```{r}
# Extract Article Data
xslPath = "./Article.xsl"
xslDoc = read_xml(xslPath,package="xslt")
article_raw = xml_xslt(xmlDoc,xslDoc)
article = unique(xmlToDataFrame(XML::xmlParse(article_raw)))
rownames(article) <- NULL
jIds = c()
for(i in 1:nrow(article)){
  temp = article[i,]
  jIds = append(jIds,journalIssues[which(temp$ISSN==journalIssues$ISSN
                       & temp$volume==journalIssues$volume
                       & temp$issue == journalIssues$issue),]$jId)
}
article = cbind(articleId=rownames(article),jId=jIds,article)
article = subset(article, select = 1:5)
dbWriteTable(dbcon,name = "Article", value = article, append = TRUE)
```

```{sql connection=dbcon}
SELECT * FROM Article;
```


## Load AuthorShip table
```{r}
# Extract authorship Data
xslPath = "./AuthorShip.xsl"
xslDoc = read_xml(xslPath,package="xslt")
authorship_raw = xml_xslt(xmlDoc,xslDoc)
authorship = unique(xmlToDataFrame(XML::xmlParse(authorship_raw)))
rownames(authorship) <- NULL
authorIds = c()
articleIds = c()
for(i in 1:nrow(authorship)){
  temp = authorship[i,]
  articleIds = append(articleIds, article[which(temp$title==article$title),]$articleId)
  authorIds = append(authorIds,authors[which(temp$LastName==authors$lastName
                       & temp$ForeName==authors$foreName),]$authorId)
}
authorship = cbind(articleId=articleIds,authorId=authorIds,authorship)
authorship = subset(authorship, select = 1:2)
dbWriteTable(dbcon,name = "Authorship", value = authorship, append = TRUE)
```

```{sql connection=dbcon}
SELECT * FROM AuthorShip;
```


## Load History table
```{r}
# Extract History Data
xslPath = "./history.xsl"
xslDoc = read_xml(xslPath,package="xslt")
history_raw = xml_xslt(xmlDoc,xslDoc)
history = unique(xmlToDataFrame(XML::xmlParse(history_raw)))
rownames(history) <- NULL
articleIds = c()
for(i in 1:nrow(history)){
  temp = history[i,]
  articleIds = append(articleIds,article[which(temp$title==article$title),]$articleId)
}
history = cbind(hId=rownames(history),articleId=articleIds,history)
history = subset(history, select = 1:6)
dbWriteTable(dbcon,name = "History", value = history, append = TRUE)
```

```{sql connection=dbcon}
SELECT * FROM History;
```

```{r}
dbDisconnect(dbcon)
```

